<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Rutas de Hoteles</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    /* Tus estilos CSS existentes se mantienen igual */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      height: 100%;
    }

    html {
      height: 100%;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 16px;
    }

    .header h1 {
      margin: 0 0 8px 0;
      color: #1a202c;
      font-size: 24px;
      font-weight: 700;
    }

    .header p {
      margin: 0;
      color: #718096;
      font-size: 14px;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hotels-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 600px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e2e8f0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin: 0;
    }

    .hotel-count {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .hotels-list {
      flex: 1;
      overflow-y: auto;
      margin-right: -12px;
      padding-right: 12px;
    }

    .hotel-card {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 10px;
      transition: all 0.2s;
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(102, 126, 234, 0.1);
    }

    .hotel-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
    }

    .hotel-card.selected {
      border-color: #667eea;
      background: #f7faff;
    }

    .hotel-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 16px;
    }

    .hotel-info {
      flex: 1;
    }

    .hotel-route {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .hotel-name {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin: 0 0 4px 0;
    }

    .hotel-address {
      font-size: 13px;
      color: #718096;
      margin: 0 0 8px 0;
    }

    .hotel-comment {
      font-size: 13px;
      color: #4a5568;
      font-style: italic;
      margin: 0;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
    }

    .checkbox {
      width: 28px;
      height: 28px;
      cursor: pointer;
      accent-color: #667eea;
      min-width: 28px;
      min-height: 28px;
    }

    .sidebar {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: 400px;
    }

    .selected-hotels {
      flex: 1;
      overflow-y: auto;
      margin: 16px 0;
      padding-right: 8px;
    }

    .selected-hotel-item {
      background: #f7fafc;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #667eea;
    }

    .selected-hotel-name {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }

    .route-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      min-height: 48px;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-success:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-primary:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #a0aec0;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
    }

    .toast.success {
      border-left: 4px solid #48bb78;
    }

    .toast.error {
      border-left: 4px solid #f56565;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .search-box {
      margin-bottom: 16px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
      -webkit-appearance: none;
      box-sizing: border-box;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (min-width: 1024px) {
      .main-content {
        flex-direction: row;
        gap: 24px;
      }

      .hotels-section {
        flex: 1;
      }

      .sidebar {
        width: 400px;
        max-height: none;
      }

      .container {
        padding: 24px;
      }

      .header h1 {
        font-size: 32px;
      }

      .header p {
        font-size: 16px;
      }
    }

    @media (max-width: 640px) {
      .hotel-header {
        gap: 12px;
      }

      .hotel-name {
        font-size: 15px;
      }

      .hotel-address {
        font-size: 12px;
      }

      .hotel-comment {
        font-size: 12px;
      }

      .section-title {
        font-size: 18px;
      }

      .selected-hotel-item {
        padding: 10px;
      }

      .route-actions {
        gap: 10px;
      }
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1 id="app-title">Gestor de Rutas de Hoteles</h1>
      <p id="instruction-text">Selecciona los hoteles para calcular la ruta m√°s eficiente</p>
    </div>
    <div class="main-content">
      <div class="hotels-section">
        <div class="section-header">
          <h2 class="section-title">üìç Hoteles Disponibles</h2><span class="hotel-count" id="hotel-count">0
            hoteles</span>
        </div>
        <div class="search-box"><input type="text" id="search-input" class="search-input"
            placeholder="üîç Buscar hotel por nombre, ruta o direcci√≥n...">
        </div>
        <div class="hotels-list" id="hotels-list"></div>
      </div>
      <div class="sidebar">
        <div class="section-header">
          <h2 class="section-title">üó∫Ô∏è Ruta Seleccionada</h2><span class="hotel-count" id="selected-count">0
            seleccionados</span>
        </div>
        <div class="selected-hotels" id="selected-hotels">
          <div class="empty-state">
            <div class="empty-icon">
              üìå
            </div>
            <p>Selecciona hoteles de la lista para comenzar a planificar tu ruta.</p>
          </div>
        </div>
        <div class="route-actions">
          <button class="btn btn-success" id="calculate-route-btn" disabled>
            <span id="calculate-text">üß≠ Calcular Ruta √ìptima</span>
            <span id="calculate-loading" style="display: none;">
              <div class="loading-spinner"></div> Calculando...
            </span>
          </button>
          <button class="btn btn-primary" id="clear-selection-btn" disabled>
            <span>üîÑ Limpiar Selecci√≥n</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ========================================
    // AQU√ç PUEDES AGREGAR TUS HOTELES EN FORMATO JSON
    // ========================================
    const HOTELS_DATA = [
      {
        "route": 1,
        "name": "EUROSTARS GRAND MARINA",
        "address": "Moll de Bcn s/n, World Trade Center",
        "comment": "",
        "mapsLink": "https://maps.app.goo.gl/T896CvSyx5q1TAFp9",
        "lat": 41.37180142078914,
        "lng": 2.180899412611472
      },
      {
        "route": 2,
        "name": "HILTON DIAGONAL MAR",
        "address": "Pg del Taulat 262, CCIB",
        "comment": "",
        "mapsLink": "https://maps.app.goo.gl/MXUKGKTfrgAeiWNKA",
        "lat": 41.40871094414003,
        "lng": 2.217446403510998
      },
      {
        "route": 2,
        "name": "LEONARDO BCN FORUM",
        "address": "Pg del Taulat 278, CCIB",
        "comment": "",
        "mapsLink": "https://maps.app.goo.gl/maa2C2w6nAR5wk1D7"
      },
      {
        "route": 2,
        "name": "BARCELONA PRINCESS",
        "address": "Av. Diagonal 1, Esq. Pg. Del Taulat",
        "comment": "",
        "mapsLink": "https://maps.app.goo.gl/oKNkMriiubTXiJY57"
      },
      {
        "route": 2,
        "name": "SB DIAGONAL ZERO",
        "address": "Pl. de Llevant s/n, Frente Torre Telef√≥nica",
        "comment": "",
        "mapsLink": "https://maps.app.goo.gl/khW9aGa9wM1xdYhK8"
      },
      {
        "route": 2,
        "name": "TEMBO BARCELONA",
        "address": "Ram√≥n Llull 479-487",
        "comment": "Por detr√°s del SB D. Zero, lado Bes√≥s",
        "mapsLink": "https://maps.app.goo.gl/utMpaygC9Cm5SN2a7"
      },
      {
        "route": 2,
        "name": "SLS BARCELONA",
        "address": "Carrer de la Pau 2",
        "comment": "Port Forum, Sant Adri√†",
        "mapsLink": "https://maps.app.goo.gl/mJkDuXd529TgaYaj8"
      },
      {
        "route": 3,
        "name": "SOFITEL SKIPPER",
        "address": "Av. Del Litoral 10",
        "comment": "Antes de llegar al Arts",
        "mapsLink": "https://maps.app.goo.gl/bmdFCWYdTyDBG6jg9"
      },
      {
        "route": 3,
        "name": "SB ICARIA",
        "address": "Av. D'Ic√†ria 195",
        "comment": "Esq. Avila, lado monta√±a/Bes√≥s",
        "mapsLink": "https://maps.app.goo.gl/Hdrozu2ejPWq9Psk6"
      },
      {
        "route": 3,
        "name": "H10 MARINA",
        "address": "Av. Del Bogatell 64",
        "comment": "Villa Ol√≠mpica",
        "mapsLink": "https://maps.app.goo.gl/35q2UnUcwb382C4W9"
      },
      {
        "route": 4,
        "name": "SB GLOW",
        "address": "Badajoz 148",
        "comment": "Subiendo a Pl. Glories a mano dcha",
        "mapsLink": "https://maps.app.goo.gl/iRSzX8fxk8fHKQYG7"
      },
      {
        "route": 4,
        "name": "THE HOXTON POBLENOU",
        "address": "Av. Diagonal 205",
        "comment": "A dcha, junto torre Gl√≤ries/Agbar",
        "mapsLink": "https://maps.app.goo.gl/rYhL1jCoULqCNuML7"
      },
      {
        "route": 4,
        "name": "NOVOTEL BARCELONA CITY",
        "address": "Ciutat de Granada 201",
        "comment": "Esq. Diagonal",
        "mapsLink": "https://maps.app.goo.gl/m7zhnzgpxZKxovNJ7"
      },
      {
        "route": 4,
        "name": "MELI√Å BARCELONA SKY",
        "address": "Lope de Vega 141",
        "comment": "Esq. Diagonal y Pere IV",
        "mapsLink": "https://maps.app.goo.gl/J33uypRavXyqsx5i9"
      },
      {
        "route": 4,
        "name": "LABTWENTYTWO BCN",
        "address": "Carrer del Per√∫ 102",
        "comment": "Paralela a C31, entre Espronceda y Bilbao",
        "mapsLink": "https://maps.app.goo.gl/nHk1pWsXWoBr5o6Q9"
      },
      {
        "route": 5,
        "name": "OCCIDENTAL ATENEA MAR",
        "address": "Pg. De Garc√≠a F√†ria 37",
        "comment": "",
        "mapsLink": "https://maps.app.goo.gl/1V3LmCA3siYFp55g7"
      },
      {
        "route": 5,
        "name": "ILUNION BARCELONA",
        "address": "Ram√≥n Turr√≥ 196",
        "comment": "Esq. Llacuna, lado mar",
        "mapsLink": "https://maps.app.goo.gl/8i1tu1cKviBxLq8GA"
      },
      {
        "route": 5,
        "name": "PAXTON BCN",
        "address": "Lull 160",
        "comment": "Entre Llacuna y Roc Boronat, lado mar",
        "mapsLink": "https://maps.app.goo.gl/pDKwwLcXWVYHvPHB8"
      },
      {
        "route": 6,
        "name": "ILUNION BEL-ART",
        "address": "Lepant 406",
        "comment": "En frente Cuartel de Lepant",
        "mapsLink": "https://maps.app.goo.gl/d92wVs4PM1C7jQNC8"
      },
      {
        "route": 6,
        "name": "RADISSON BLU 1882",
        "address": "C√≤rsega 482",
        "comment": "Esq. Sicilia, lado mar/Llobregat",
        "mapsLink": "https://maps.app.goo.gl/C94jzwdX7YA6U75QA"
      },
      {
        "route": 6,
        "name": "NH PODIUM",
        "address": "Bail√©n 4-6",
        "comment": "Esq. Ali Bei, lado monta√±a/Bes√≥s",
        "mapsLink": "https://maps.app.goo.gl/8iN6xnoqyzLhoGNQ9"
      },
      {
        "route": 6,
        "name": "CASA BONAY",
        "address": "Gran Via CC 700",
        "comment": "Antes de llegar a Pza Tetu√°n, a la dcha (esq. Bail√©n)",
        "mapsLink": "https://maps.app.goo.gl/yNNnRHbXqgX7EKkRA"
      },
      {
        "route": 7,
        "name": "SEVENTY BARCELONA",
        "address": "C√≤rsega 344",
        "comment": "Entre R. de Ll√∫ria y Pau Claris, lado mar",
        "mapsLink": "https://maps.app.goo.gl/L5xVMd9a9Mdn7tL97"
      },
      {
        "route": 7,
        "name": "THE ONE BARCELONA GL",
        "address": "Proven√ßa 277",
        "comment": "Esq. Pau Claris, lado monta√±a",
        "mapsLink": "https://maps.app.goo.gl/SsND3z8KBPnq2das9"
      },
      {
        "route": 7,
        "name": "SIR VICTOR HOTEL",
        "address": "Rossell√≥ 265",
        "comment": "Entre Pau Claris y Pg de Gr√†cia, lado monta√±a",
        "mapsLink": "https://maps.app.goo.gl/aYAbVubqXbtXyoKU9"
      },
      {
        "route": 7,
        "name": "GALLERY",
        "address": "Rossell√≥ 249",
        "comment": "Entre Rbla. Cat y Pg de Gr√†cia, lado monta√±a",
        "mapsLink": "https://maps.app.goo.gl/8b3YhEGRQXAtFzga8"
      }
    ];

    // Colores asignados a cada ruta
    const ROUTE_COLORS = {
      1: '#FF6B6B',   // Rojo
      2: '#4ECDC4',   // Turquesa
      3: '#45B7D1',   // Azul
      4: '#FFA07A',   // Salm√≥n
      5: '#98D8C8',   // Verde menta
      6: '#F7DC6F',   // Amarillo
      7: '#BB8FCE',   // P√∫rpura
      8: '#F8B739',   // Naranja
      9: '#85C1E2',   // Azul claro
      10: '#F1948A'   // Rosa
    };

    // ========================================
    // CONFIGURACI√ìN TOMTOM
    // ========================================
    const TOMTOM_API_KEY = 'YOUR_TOMTOM_API_KEY'; // Reemplaza con tu API Key de TomTom

    const defaultConfig = {
      app_title: "Gestor de Rutas de Hoteles",
      instruction_text: "Selecciona los hoteles para calcular la ruta m√°s eficiente",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#2d3748",
      primary_action_color: "#667eea",
      secondary_action_color: "#48bb78",
      font_family: "Inter",
      font_size: 16
    };

    let hotels = [];
    let filteredHotels = [];
    let userLocation = null;

    function getRouteColor(routeNumber) {
      return ROUTE_COLORS[routeNumber] || '#667eea';
    }

    function initializeHotels() {
      hotels = HOTELS_DATA.map((hotel, index) => ({
        ...hotel,
        id: `hotel-${index}`,
        selected: false,
        color: getRouteColor(hotel.route)
      }));
      filteredHotels = [...hotels];
      renderHotelsList();
      updateCounts();
    }

    function renderHotelsList() {
      const listContainer = document.getElementById('hotels-list');

      if (filteredHotels.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <p>No se encontraron hoteles con ese criterio de b√∫squeda.</p>
          </div>
        `;
        return;
      }

      listContainer.innerHTML = filteredHotels.map(hotel => `
        <div class="hotel-card ${hotel.selected ? 'selected' : ''}" data-id="${hotel.id}">
          <div class="hotel-header">
            <div class="hotel-info">
              <span class="hotel-route" style="background-color: ${hotel.color};">Ruta ${hotel.route}</span>
              <h3 class="hotel-name">${hotel.name}</h3>
              <p class="hotel-address">üìç ${hotel.address}</p>
              ${hotel.comment ? `<p class="hotel-comment">${hotel.comment}</p>` : ''}
            </div>
            <div class="checkbox-container">
              <input type="checkbox" class="checkbox" ${hotel.selected ? 'checked' : ''} 
                     data-id="${hotel.id}"
                     onclick="event.stopPropagation()">
            </div>
          </div>
        </div>
      `).join('');

      listContainer.querySelectorAll('.hotel-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('checkbox')) {
            const id = card.dataset.id;
            toggleHotelSelection(id);
          }
        });
      });

      listContainer.querySelectorAll('.checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          toggleHotelSelection(id);
        });
      });
    }

    function renderSelectedHotels() {
      const selectedContainer = document.getElementById('selected-hotels');
      const selectedHotels = hotels.filter(h => h.selected);

      if (selectedHotels.length === 0) {
        selectedContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìå</div>
            <p>Selecciona hoteles de la lista para comenzar a planificar tu ruta.</p>
          </div>
        `;
        document.getElementById('calculate-route-btn').disabled = true;
        document.getElementById('clear-selection-btn').disabled = true;
        return;
      }

      selectedContainer.innerHTML = selectedHotels.map((hotel, index) => `
        <div class="selected-hotel-item" style="border-left-color: ${hotel.color};">
          <div>
            <div class="selected-hotel-name">${index + 1}. ${hotel.name}</div>
            <div style="font-size: 12px; color: #718096; margin-top: 4px;">Ruta ${hotel.route}</div>
          </div>
          <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${hotel.color};"></div>
        </div>
      `).join('');

      document.getElementById('calculate-route-btn').disabled = selectedHotels.length < 2;
      document.getElementById('clear-selection-btn').disabled = false;
    }

    function updateCounts() {
      document.getElementById('hotel-count').textContent = `${filteredHotels.length} hoteles`;
      const selectedCount = hotels.filter(h => h.selected).length;
      document.getElementById('selected-count').textContent = `${selectedCount} seleccionados`;
    }

    function toggleHotelSelection(id) {
      const hotel = hotels.find(h => h.id === id);
      if (!hotel) return;

      hotel.selected = !hotel.selected;
      renderHotelsList();
      renderSelectedHotels();
      updateCounts();
    }

    function filterHotels(searchTerm) {
      const term = searchTerm.toLowerCase().trim();

      if (!term) {
        filteredHotels = [...hotels];
      } else {
        filteredHotels = hotels.filter(hotel =>
          hotel.name.toLowerCase().includes(term) ||
          hotel.address.toLowerCase().includes(term) ||
          hotel.route.toString().includes(term) ||
          (hotel.comment && hotel.comment.toLowerCase().includes(term))
        );
      }

      renderHotelsList();
      updateCounts();
    }

    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function setLoadingState(loading) {
      const btn = document.getElementById('calculate-route-btn');
      const text = document.getElementById('calculate-text');
      const loadingEl = document.getElementById('calculate-loading');

      if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
        text.style.display = 'none';
        loadingEl.style.display = 'inline-flex';
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
        text.style.display = 'inline-flex';
        loadingEl.style.display = 'none';
      }
    }

    // Funci√≥n para obtener la ubicaci√≥n del usuario
    function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocalizaci√≥n no soportada'));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            resolve(userLocation);
          },
          (error) => {
            reject(error);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      });
    }

    // Funci√≥n para geocodificar una direcci√≥n usando TomTom
    async function geocodeAddress(address) {
      try {
        const response = await fetch(
          `https://api.tomtom.com/search/2/geocode/${encodeURIComponent(address)}.json?key=${TOMTOM_API_KEY}&limit=1`
        );

        if (!response.ok) {
          throw new Error('Error en geocodificaci√≥n');
        }

        const data = await response.json();

        if (data.results && data.results.length > 0) {
          const result = data.results[0];
          return {
            lat: result.position.lat,
            lng: result.position.lon
          };
        } else {
          throw new Error('Direcci√≥n no encontrada');
        }
      } catch (error) {
        console.error('Error en geocodificaci√≥n:', error);
        throw error;
      }
    }

    // Funci√≥n principal para calcular ruta optimizada con TomTom
    async function calculateTomTomRoute(selectedHotels) {
      try {
        setLoadingState(true);

        // 1. Obtener ubicaci√≥n del usuario
        showToast('Obteniendo tu ubicaci√≥n actual...', 'success');
        await getUserLocation();

        // 2. Geocodificar direcciones de hoteles
        showToast('Calculando mejores rutas...', 'success');
        const waypoints = [];

        for (const hotel of selectedHotels) {
          const coords = await geocodeAddress(hotel.address);
          waypoints.push({
            ...coords,
            name: hotel.name
          });
        }

        // 3. Construir URL para TomTom Route Planner
        // TomTom no tiene optimizaci√≥n autom√°tica como Google, pero podemos usar el orden actual
        const origin = `${userLocation.lat},${userLocation.lng}`;
        const destination = `${waypoints[waypoints.length - 1].lat},${waypoints[waypoints.length - 1].lng}`;

        // Crear waypoints intermedios (todos menos el √∫ltimo)
        const intermediateWaypoints = waypoints.slice(0, -1)
          .map(wp => `${wp.lat},${wp.lng}`)
          .join(':');

        let tomtomUrl = `https://api.tomtom.com/routing/1/calculateRoute/`;

        if (intermediateWaypoints) {
          tomtomUrl += `${origin}:${intermediateWaypoints}:${destination}/json?`;
        } else {
          tomtomUrl += `${origin}:${destination}/json?`;
        }

        tomtomUrl += `key=${TOMTOM_API_KEY}`;
        tomtomUrl += `&travelMode=car`;
        tomtomUrl += `&routeType=fastest`;
        tomtomUrl += `&traffic=true`;
        tomtomUrl += `&instructionsType=text`;
        tomtomUrl += `&language=es-ES`;
        tomtomUrl += `&vehicleMaxSpeed=120`;
        tomtomUrl += `&vehicleWeight=1600`;
        tomtomUrl += `&vehicleCommercial=false`;
        tomtomUrl += `&vehicleLoadType=0`;
        tomtomUrl += `&vehicleEngineType=combustion`;

        // 4. Obtener la ruta de TomTom
        const response = await fetch(tomtomUrl);

        if (!response.ok) {
          throw new Error('Error al calcular la ruta');
        }

        const routeData = await response.json();

        // 5. Crear URL para TomTom Maps con la ruta calculada
        const mapUrl = createTomTomMapUrl(origin, waypoints, routeData);

        // 6. Abrir en nueva pesta√±a
        window.open(mapUrl, '_blank', 'noopener noreferrer');

        showToast('¬°Ruta calculada exitosamente! üó∫Ô∏è', 'success');

      } catch (error) {
        console.error('Error calculando ruta TomTom:', error);

        if (error.code === 1) {
          showToast('Permiso de ubicaci√≥n denegado. Usando ubicaci√≥n por defecto.', 'error');
          // Fallback a ubicaci√≥n por defecto (centro de Barcelona)
          userLocation = { lat: 41.3851, lng: 2.1734 };
          // Reintentar sin ubicaci√≥n del usuario
          await calculateTomTomRouteFallback(selectedHotels);
        } else {
          showToast('Error al calcular la ruta. Intenta de nuevo.', 'error');
        }
      } finally {
        setLoadingState(false);
      }
    }

    // Fallback cuando no se puede obtener la ubicaci√≥n
    async function calculateTomTomRouteFallback(selectedHotels) {
      try {
        const addresses = selectedHotels.map(h => h.address);
        const origin = encodeURIComponent("Barcelona, Espa√±a");
        const destination = encodeURIComponent(addresses[addresses.length - 1]);
        const waypoints = addresses.slice(0, -1).map(encodeURIComponent).join('|');

        const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}&travelmode=driving&optimize=true`;

        window.open(mapsUrl, '_blank', 'noopener noreferrer');
        showToast('Ruta calculada con ubicaci√≥n por defecto üó∫Ô∏è', 'success');
      } catch (fallbackError) {
        showToast('Error cr√≠tico al calcular ruta', 'error');
      }
    }

    // Crear URL para TomTom Maps
    function createTomTomMapUrl(origin, waypoints, routeData) {
      let mapUrl = `https://api.tomtom.com/map/1/basic.html?key=${TOMTOM_API_KEY}`;

      // A√±adir origen
      mapUrl += `&origin=${origin}`;

      // A√±adir destino
      const destination = `${waypoints[waypoints.length - 1].lat},${waypoints[waypoints.length - 1].lng}`;
      mapUrl += `&destination=${destination}`;

      // A√±adir waypoints intermedios
      if (waypoints.length > 2) {
        const intermediate = waypoints.slice(0, -1)
          .map(wp => `${wp.lat},${wp.lng}`)
          .join(',');
        mapUrl += `&waypoints=${intermediate}`;
      }

      // A√±adir configuraci√≥n del mapa
      mapUrl += `&center=${userLocation.lat},${userLocation.lng}`;
      mapUrl += `&zoom=12`;
      mapUrl += `&layer=basic`;
      mapUrl += `&traffic=flow`;

      return mapUrl;
    }

    // Event Listeners
    document.getElementById('search-input').addEventListener('input', (e) => {
      filterHotels(e.target.value);
    });

    document.getElementById('calculate-route-btn').addEventListener('click', async () => {
      const selectedHotels = hotels.filter(h => h.selected);
      if (selectedHotels.length < 2) {
        showToast('Selecciona al menos 2 hoteles para calcular la ruta', 'error');
        return;
      }

      await calculateTomTomRoute(selectedHotels);
    });

    document.getElementById('clear-selection-btn').addEventListener('click', () => {
      hotels.forEach(hotel => hotel.selected = false);
      renderHotelsList();
      renderSelectedHotels();
      updateCounts();
      showToast('Selecci√≥n limpiada', 'success');
    });

    // Inicializaci√≥n de la aplicaci√≥n
    async function initializeApp() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            // Tu c√≥digo existente de configuraci√≥n...
            const appTitle = document.getElementById('app-title');
            const instructionText = document.getElementById('instruction-text');
            const customFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
            const baseSize = config.font_size || defaultConfig.font_size;

            if (appTitle) {
              appTitle.textContent = config.app_title || defaultConfig.app_title;
              appTitle.style.fontFamily = `${customFont}, ${baseFontStack}`;
              appTitle.style.fontSize = `${baseSize * 2}px`;
              appTitle.style.color = config.text_color || defaultConfig.text_color;
            }

            if (instructionText) {
              instructionText.textContent = config.instruction_text || defaultConfig.instruction_text;
              instructionText.style.fontFamily = `${customFont}, ${baseFontStack}`;
              instructionText.style.fontSize = `${baseSize}px`;
            }

            document.body.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, #764ba2 100%)`;

            const surfaces = document.querySelectorAll('.header, .hotels-section, .sidebar, .hotel-card, .selected-hotel-item');
            surfaces.forEach(el => {
              el.style.background = config.surface_color || defaultConfig.surface_color;
            });

            const textElements = document.querySelectorAll('.section-title, .hotel-name, .hotel-address, .hotel-comment, .selected-hotel-name');
            textElements.forEach(el => {
              el.style.color = config.text_color || defaultConfig.text_color;
              el.style.fontFamily = `${customFont}, ${baseFontStack}`;
            });

            const primaryBtns = document.querySelectorAll('.btn-primary, .hotel-count, .hotel-route');
            primaryBtns.forEach(el => {
              el.style.background = config.primary_action_color || defaultConfig.primary_action_color;
            });

            const successBtns = document.querySelectorAll('.btn-success');
            successBtns.forEach(el => {
              el.style.background = config.secondary_action_color || defaultConfig.secondary_action_color;
            });

            const checkboxes = document.querySelectorAll('.checkbox');
            checkboxes.forEach(el => {
              el.style.accentColor = config.primary_action_color || defaultConfig.primary_action_color;
            });

            const selectedItems = document.querySelectorAll('.selected-hotel-item');
            selectedItems.forEach(el => {
              el.style.borderLeftColor = config.primary_action_color || defaultConfig.primary_action_color;
            });
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["instruction_text", config.instruction_text || defaultConfig.instruction_text]
          ])
        });
      }

      initializeHotels();
    }

    initializeApp();
  </script>
</body>

</html>